<html><head><meta charset='utf-8'><meta name='viewport' content='width=device-width, initial-scale=1'>
<meta name='applicable-device' content='pc'><meta name='keywords' content='ç”µè„‘,ç”µè„‘è®²è§£,ç”µè„‘æŠ€æœ¯,ç¼–ç¨‹,ç”µè„‘æ•…éšœç»´ä¿®ç”±ä¸€æ¬¡çº¿ä¸Šæ•…éšœæ¥ç†è§£ä¸‹ TCP ä¸‰æ¡ã€å››æŒ¥ &amp; Java å †æ ˆåˆ†æåˆ°æºç çš„æ¢ç§˜' />
<script src='../../highlight/highlight.pack.js'></script>
<link rel='stylesheet' type='text/css' href='../../highlight/styles/monokai.css'/>

<link rel='stylesheet' href='../../fenxiang/dist/css/share.min.css'>
<script src='../../fenxiang/src/js/social-share.js'></script>
<script src='../../fenxiang/src/js/qrcode.js'></script>

</head><body><script>hljs.initHighlightingOnLoad();</script><script>
var system ={};  
var p = navigator.platform;       
system.win = p.indexOf('Win') == 0;  
system.mac = p.indexOf('Mac') == 0;  
system.x11 = (p == 'X11') || (p.indexOf('Linux') == 0);     
if(system.win||system.mac||system.xll){
document.write("<link href='../css/3.css' rel='stylesheet' type='text/css'>");}else{ document.write("<link href='../css/3wap.css' rel='stylesheet' type='text/css'>");}</script><script src='../../js/3.js'></script><div class='div2'><div class='heading_nav'><ul><div><li><a href='../../index.html'>é¦–é¡µ</a></li>
</div><div onclick='hidden1()' >åˆ†äº«</div>
</ul></div></div>
<div id='heading_nav2'> 
<li class='row' >
<div class='social-share' data-mode='prepend'><a href='javascript:' class='social-share-icon icon-heart'></a></div></li></div><script charset='utf-8' src='../../3/js/hengfu.js'></script><script charset='utf-8' src='../../3/js/hengfu2.js'></script><hr><div class='div1'><div class='biaoti'><center>ç”±ä¸€æ¬¡çº¿ä¸Šæ•…éšœæ¥ç†è§£ä¸‹ TCP ä¸‰æ¡ã€å››æŒ¥ &amp; Java å †æ ˆåˆ†æåˆ°æºç çš„æ¢ç§˜</center></div><div class='banquan'>åŸæ–‡å‡ºå¤„:æœ¬æ–‡ç”±åšå®¢å›­åšä¸»Javaçˆ±å¥½è€…ç¤¾åŒºæä¾›ã€‚<br/>
åŸæ–‡è¿æ¥:https://www.cnblogs.com/ldws/p/11704115.html</div><br>
    <p><strong>æœ¬æ–‡å¯¼è¯»ï¼š</strong></p>
<ul>
<li>ç”Ÿäº§æ•…éšœåœºæ™¯ä»‹ç»</li>
<li>TCP å»ºè¿ä¸‰æ¬¡æ¡æ‰‹è¿‡ç¨‹</li>
<li>TCP æ–­è¿å››æ¬¡æŒ¥æ‰‹è¿‡ç¨‹</li>
<li>ç»“åˆ Java å †æ ˆå‰–ææºç </li>
<li>å†ä»å †æ ˆä¸­æ‰¾åˆ°&quot;ç½ªé­ç¥¸é¦–&quot;</li>
<li>é—®é¢˜ä¼˜åŒ–æ–¹æ¡ˆæ€»ç»“</li>
</ul>
<hr />
<h5 id="ç”Ÿäº§æ•…éšœåœºæ™¯ä»‹ç»"><strong>1ã€ç”Ÿäº§æ•…éšœåœºæ™¯ä»‹ç»</strong></h5>
<p>ä¸šåŠ¡ç®€ä»‹ï¼š</p>
<p>è¯¥æœåŠ¡ä¸»è¦æ˜¯æä¾›å¯¹å¤–çš„ä»£ç†æ¥å£ï¼Œå¤§éƒ¨åˆ†æ¥å£éƒ½ä¼šè°ƒç”¨ç¬¬ä¸‰æ–¹æ¥å£ï¼Œè·å–æ•°æ®ååšèšåˆå¤„ç†åï¼Œæä¾›ç»™å®¢æˆ·ç«¯ä½¿ç”¨ã€‚</p>
<p>æœ‰ä¸€å¤©æ™šä¸Šï¼Œç³»ç»Ÿæ­£å¤„äºé«˜å³°æœŸé—´ï¼Œé¡¹ç›®ç»„å°ä¼™ä¼´æ­£åœ¨æ´¥æ´¥æœ‰å‘³çš„åƒç€ã€ŒåŠ ç­é¤ã€ï¼ŒåˆšæŠŠğŸšå¡è¿›å˜´é‡Œï¼Œé‚®ä»¶å’ŒçŸ­ä¿¡åŒæ—¶å‘èµ·æ¥å‘Šè­¦ã€‚</p>
<p>æœ‰ä¸€å°æœåŠ¡å™¨æ¥å£è¶…æ—¶ï¼Œå¹³æ—¶å¶å°”ä¹Ÿä¼šæ”¶åˆ°ç±»ä¼¼å‘Šè­¦ï¼Œæœ‰æ—¶ä¼šå› ä¸ºç½‘ç»œæ³¢åŠ¨ç­‰åŸå› ã€‚å®åœ¨ä¸å¥½æ„æ€ï¼Œæ²¡äº‹æ€»è®©äººå®¶ã€Œç½‘ç»œã€åŒå­¦èƒŒé”… : )ã€‚ä½†æ˜¯ï¼Œè¿™æ¬¡å‘Šè­¦å¹¶æ²¡æœ‰æ”¶æ•›ï¼ŒæŒç»­å‘Šè­¦äº†åå‡ åˆ†é’Ÿä»¥ä¸Šï¼Œæ„Ÿåˆ°äº†ä¸å¦™ã€‚</p>
<p>ç‚¹å‡»é‚®ä»¶ä¸­å‘Šè­¦çš„ URL æ¥å£é“¾æ¥ï¼Œä¸€ç›´åœ¨é¡µé¢è½¬åœˆåœˆï¼Œå“åº”å¾ˆæ…¢ï¼Œæ‚²å‰§ï¼</p>
<p>æ­¤åˆ»ï¼Œé»˜é»˜çš„æŠŠğŸ±ç›’é¥­æ¨åˆ°ä¸€è¾¹å»ï¼Œä¸å¿ç›´è§† :(</p>
<p><strong>é—®é¢˜å®šä½åŸºæœ¬æµç¨‹ï¼š</strong></p>
<p>1ï¼‰ç¡®å®šå½±å“èŒƒå›´</p>
<p>è¯¥æœåŠ¡åé¢æŒ‚ç€å¤šå°æœåŠ¡å™¨ï¼Œä»…æœ‰ä¸€å°æœåŠ¡å™¨æŒ‚æ‰äº†ï¼Œæ‰€ä»¥å¯¹ç”¨æˆ·ä¸ä¼šæœ‰å¤ªå¤§çš„å½±å“ã€‚<br />
å…ˆä¸´æ—¶ä»æ³¨å†Œä¸­å¿ƒä¸Šæ‘˜æ‰ï¼Œåˆ«è®©å®¢æˆ·ç«¯ç»§ç»­é‡è¯•åˆ°è¿™å°æœºå™¨ä¸Šäº†ï¼Œä¿ç•™äº‹æ•…ç°åœºã€‚</p>
<p>2ï¼‰æ’æŸ¥ç›‘æ§æŒ‡æ ‡</p>
<p>æŸ¥çœ‹æ¥å£æœåŠ¡çš„è®¿é—®é‡ï¼Œå› ä¸ºæ˜¯æ™šé«˜å³°ï¼Œå› æ­¤ä¼šæ¯”å…¶ä»–æ—¶é—´æ®µç”¨æˆ·è®¿é—®é‡ä¼šæ›´å¤§äº›ï¼Œä½†æ˜¯è¿™ä¸ªè®¿é—®é‡çœ‹ä¸Šå»è·Ÿå¹³æ—¶åŒä¸€æ—¶æ®µå¯¹æ¯”ï¼Œå¹¶æ²¡æœ‰ç‰¹åˆ«æ˜æ˜¾çªå¢ç°è±¡ã€‚<br />
ç›‘æ§ä¸Šè§‚å¯ŸæœåŠ¡å™¨çš„ CPUã€å†…å­˜ã€IOã€ç½‘ç»œæŒ‡æ ‡çœ‹èµ·æ¥ä¹Ÿä¸€åˆ‡æ­£å¸¸ã€‚</p>
<p>3ï¼‰æœåŠ¡å™¨æ’æŸ¥</p>
<p>ç™»å½•åˆ°æœåŠ¡å™¨ä¸Šï¼Œç»“åˆç›‘æ§è¿›ä¸€æ­¥æŸ¥çœ‹æœåŠ¡å™¨ CPUã€å†…å­˜ ç­‰æŒ‡æ ‡ï¼ŒæŸ¥çœ‹æœåŠ¡æ—¥å¿—éƒ½æ˜¯æ­£å¸¸çš„ï¼Œå¹¶ä¸”ä¹Ÿæ²¡æœ‰å‘ç°ç‰¹åˆ«çš„å¼‚å¸¸æ—¥å¿—è¾“å‡ºï¼ŒException æˆ–è€… OOM ç­‰å¼‚å¸¸ã€‚</p>
<p>æˆ‘ä»¬çœ‹åˆ°çš„ç°è±¡æ˜¯ï¼Œæ¥å£æœåŠ¡å·²ç»æ— æ³•æ­£å¸¸å“åº”äº†ï¼Œåº”ç”¨è·‘åœ¨ JVM ä¸Šï¼Œå¿«é€Ÿé€šè¿‡ JDK è‡ªå¸¦çš„å¸¸ç”¨å‘½ä»¤æ’æŸ¥ä¸€ç•ªäº†ã€‚</p>
<p>å¦‚ä¸‹å‘½ä»¤æ‰“å°å †æ ˆä¿¡æ¯ï¼š</p>
<p><code>jstack -l $pid &gt; jstack.log</code></p>
<p>ç»Ÿè®¡ç»“æœå¦‚ä¸‹ï¼š</p>
<p><code>cat jstack.log  | grep &quot;java.lang.Thread.State&quot; | sort -nr | uniq -c</code></p>
<pre><code><code>994    java.lang.Thread.State: WAITING (parking)
501    java.lang.Thread.State: WAITING (on object monitor)
7      java.lang.Thread.State: TIMED_WAITING (sleeping)
13     java.lang.Thread.State: TIMED_WAITING (parking)
2      java.lang.Thread.State: TIMED_WAITING (on object monitor)
23     java.lang.Thread.State: RUNNABLE</code></code></pre>
<p>å¦‚æœé‡åˆ° java.lang.Thread.State: WAITING (parking)ã€java.lang.Thread.State: WAITING (on object monitor) è¿™ç±»çº¿ç¨‹çŠ¶æ€ï¼Œå°±è¦å¼•èµ·æ³¨æ„äº†ï¼Œä¸€èˆ¬å¯èƒ½éƒ½æ˜¯ç¨‹åºæœ¬èº«é—®é¢˜å¯¼è‡´çš„ã€‚</p>
<p>æ ¹æ® java.lang.Thread.State: WAITING æŸ¥çœ‹ jstack.log é‡Œçš„å †æ ˆä¿¡æ¯ï¼Œå‘ç°äº†äº†å¤§é‡çš„è°ƒç”¨ HttpClient å·¥å…·ç±»è¯·æ±‚ç­‰å¾…æŒ‚èµ·çš„æ—¥å¿—ï¼Œå…·ä½“å †æ ˆä¿¡æ¯å¾…ä¸‹é¢è¯¦ç»†åˆ†æã€‚</p>
<p>è¿™äº›æœåŠ¡è°ƒç”¨éƒ½æ˜¯é€šè¿‡ HttpClient å·¥å…·ç›´æ¥è°ƒç”¨çš„ï¼Œå¯¹ Spring RestTemplate åšäº†ä¸€æ¬¡å°è£…ï¼Œå…¶åº•å±‚ä¹Ÿæ˜¯è°ƒç”¨çš„ Apache HttpClient å·¥å…·ç±»æ¥å®ç°æœåŠ¡è°ƒç”¨çš„ã€‚</p>
<p>é™¤çœ‹åˆ°ä¸Šè¿° jstack æ—¥å¿—å¼‚å¸¸å¤–ï¼Œè¿˜æ’æŸ¥äº†æœåŠ¡å™¨ä¸Šçš„ç½‘ç»œçŠ¶æ€ï¼Œè¿™ä¹Ÿæ˜¯è¿ç»´åŒå­¦ä»¬å¸¸ç”¨çš„æ’æŸ¥æ‰‹æ®µã€‚</p>
<p>é™„ä¸Šç»Ÿè®¡ç½‘ç»œè¿æ¥çŠ¶æ€çš„å‘½ä»¤ï¼š</p>
<p><code>netstat -n | awk '/^tcp/ {++State[$NF]} END {for(i in State) print i, State[i]}'</code></p>
<p>ç»Ÿè®¡ç»“æœï¼š</p>
<pre><code><code>TIME_WAIT 9
CLOSE_WAIT 3826
SYN_SENT 2
ESTABLISHED 28
SYN_RECV 8</code></code></pre>
<p>è¿™é‡Œæ³¨æ„äº†ï¼Œæˆ‘ä»¬çœ‹åˆ°æœåŠ¡å™¨è¯¡å¼‚çš„ç½‘ç»œè¿æ¥ç»Ÿè®¡ä¸­ï¼Œå‡ºç°äº†å¤§é‡çš„ CLOSE_WAIT çŠ¶æ€çš„è¿æ¥ã€‚</p>
<p>è€Œä¸”è¿™ä¸ªçŠ¶æ€ï¼Œå½“ä½ é—´éš”ä¸€æ®µæ—¶é—´å†æ¬¡æ‰§è¡Œç»Ÿè®¡å‘½ä»¤ï¼Œè¿˜æ˜¯ä¼šå­˜åœ¨ï¼Œä¹Ÿå°±æ˜¯ä¸ä¼šè¢«é‡Šæ”¾æ‰äº†ï¼Œçœ‹ä¸Šå»é—®é¢˜æœ‰äº›ä¸¥é‡ã€‚</p>
<p>è¿›ä¸€æ­¥çŒœæµ‹ï¼Œå‡ºç°è¿™äº› CLOSE_WAIT çŠ¶æ€è·Ÿæ¥å£å“åº”æ…¢åº”è¯¥æ˜¯æœ‰å…³ç³»çš„ï¼ŒåŒæ—¶ï¼Œä¹Ÿè·Ÿ java å †æ ˆä¿¡æ¯ä¸­å‡ºç°çš„ HttpClient çº¿ç¨‹é˜»å¡æœ‰å…³ç³»ï¼Œä½œä¸ºé—®é¢˜çªç ´å£å»åˆ†æã€‚</p>
<p>ä¸å¦‚ï¼Œæˆ‘ä»¬å…ˆæ¥äº†è§£ä¸‹ CLOSE_WAIT çŠ¶æ€ï¼Œè¿™ä¸ª CLOSE_WAIT çŠ¶æ€å¤„äº TCP ç½‘ç»œæ–­å¼€è¿æ¥è¿‡ç¨‹ä¸­ï¼Œå½“å®¢æˆ·ç«¯å‘èµ·æ–­è¿è¯·æ±‚ï¼ŒæœåŠ¡ç«¯é¦–æ¬¡æ”¶åˆ°æ–­è¿è¯·æ±‚ï¼Œå›å¤ç¡®è®¤æ¶ˆæ¯ï¼Œä¹‹åä¾¿å¤„äº CLOSE_WAIT çŠ¶æ€äº†ï¼Œå½“æœåŠ¡ç«¯å“åº”å¤„ç†å®Œæ¯•ä¼šå›å¤ç½‘ç»œåŒ…ç»™å®¢æˆ·ç«¯ï¼Œæ­£å¸¸è¿æ¥ä¼šè¢«å…³é—­æ‰çš„ã€‚</p>
<h5 id="tcp-å»ºè¿ä¸‰æ¬¡æ¡æ‰‹è¿‡ç¨‹"><strong>2ã€ TCP å»ºè¿ä¸‰æ¬¡æ¡æ‰‹è¿‡ç¨‹</strong></h5>
<p>å°½ç®¡ CLOSE_WAIT çŠ¶æ€æ˜¯åœ¨ TCP ç½‘ç»œè¿æ¥å››æ¬¡æŒ¥æ‰‹è¿‡ç¨‹ä¸­çš„ã€‚æˆ‘ä»¬è¿˜æ˜¯æœ‰å¿…è¦ï¼Œå…ˆæ¥äº†è§£ä¸‹ TCP ç½‘ç»œè¿æ¥çš„ä¸‰æ¬¡æ¡æ‰‹ï¼Œå› ä¸ºå®ƒæ˜¯è¯·æ±‚æœåŠ¡å™¨è¦åšçš„ç¬¬ä¸€ä»¶äº‹æƒ…ï¼Œé‚£å°±æ˜¯å»ºç«‹ TCP è¿æ¥ã€‚</p>
<p>æŠ€æœ¯æºäºç”Ÿæ´»ã€‚</p>
<p>æˆ‘ä»¬å¯ä»¥ä¸¾ä¸ªæ—¥å¸¸ç”Ÿæ´»ä¸­çš„ä¾‹å­æ¥ç†è§£ TCP ä¸‰æ¬¡æ¡æ‰‹çš„è¿‡ç¨‹ã€‚</p>
<p>æ¯”å¦‚ä½ åœ¨å¾®ä¿¡ä¸Šæƒ³ä¸ä¸€ä½å¾ˆä¹…æœªæ›¾è°‹é¢çš„æœ‹å‹èŠä¸€èŠï¼š</p>
<blockquote>
<p>å°ä¸œï¼šå°å‡ï¼Œåœ¨å—ï¼Ÿ<br />
ï¼ˆè¿‡äº†å¾ˆä¹…... ... ï¼‰<br />
å°å‡: åœ¨äº†ï¼Œä½ è¿˜åœ¨å—ï¼Ÿ<br />
ï¼ˆå°ä¸œåˆšå¥½åœ¨çº¿ï¼Œå¤©å¤©åˆ·æœ‹å‹åœˆ... ... ï¼‰<br />
å°ä¸œï¼šå—¯å—¯ï¼Œåœ¨äº†<br />
ï¼ˆç„¶åä¸¤ä½å¼€å§‹çƒ­èŠèµ·æ¥... ...ï¼‰</p>
</blockquote>
<p>å¦‚æœä½ å¹³æ—¶è·Ÿæœ‹å‹ï¼Œå¼€å¤´æ€»è¿™ä¹ˆèŠå¤©æ˜¯ä¸æ˜¯è§‰å¾—å¾ˆç´¯å‘¢ã€‚</p>
<p>å…¶å®ä¸Šé¢çš„è¿‡ç¨‹ï¼Œå¯ä»¥å¾ˆå¥½çš„ç†è§£ TCP ä¸‰æ¬¡æ¡æ‰‹çš„è¿‡ç¨‹ã€‚</p>
<p>æˆ‘ä»¬å§‘ä¸”å°†<strong>å°ä¸œ</strong>çœ‹åšæ˜¯ã€Œ<strong>å®¢æˆ·ç«¯</strong>ã€ï¼Œ<strong>å°å‡</strong>çœ‹åšæ˜¯ã€Œ<strong>æœåŠ¡ç«¯</strong>ã€ã€‚<br />
å°ä¸œæ˜¯åšåç¨‹åºå‘˜ï¼Œåš IT å·¥ä½œã€‚å°å‡åœ¨è€å®¶å¼€åº—åˆ›ä¸šä¸­ã€‚</p>
<p><strong>ç†è§£TCPä¸‰æ¬¡æ¡æ‰‹è¿‡ç¨‹ï¼š</strong></p>
<p>1ï¼‰å°ä¸œä½œä¸ºã€Œå®¢æˆ·ç«¯ã€ï¼Œå‘ä½œä¸ºã€ŒæœåŠ¡ç«¯ã€çš„å°å‡å‘èµ·èŠå¤©ï¼Œå°±æ˜¯å‘é€äº†ä¸€ä¸ªç½‘ç»œåŒ…ï¼ˆåŒ…ç­¾åä¸º <code>syn</code> ï¼‰ç»™å°å‡ã€‚ã€è¿™æ˜¯ <code>TCP ç¬¬ä¸€æ¬¡æ¡æ‰‹</code>ï¼Œå°ä¸œçŠ¶æ€æ­¤æ—¶å¤„äº <code>syn_sent</code> çŠ¶æ€ã€‘</p>
<p>2ï¼‰å°å‡æ”¶åˆ°äº†å°ä¸œçš„èŠå¤©ç½‘ç»œåŒ…ï¼Œä½ å¾—ç¡®è®¤ä¸‹å§ï¼Œè¡¨ç¤ºä½ æ”¶åˆ°äº†ã€‚æ­¤æ—¶ï¼Œå°å‡è¿˜æœ‰åˆ«çš„äº‹æƒ…ï¼Œä¸åƒå°ä¸œé‚£æ ·æ IT å·¥ä½œçš„ï¼Œä¸Šç­è¿˜ä¸Šç€å¾®ä¿¡ã€‚åˆ°äº†æ™šä¸Šï¼Œå°å‡å¾—ç©ºçœ‹äº†ä¸€çœ¼æ‰‹æœºå¾®ä¿¡ï¼Œå¼¹å‡ºäº†å°ä¸œçš„æ¶ˆæ¯ã€‚ç„¶åï¼Œæ¿€åŠ¨çš„åšäº†ä¸ªå›å¤ã€Œ é’ˆå¯¹å°ä¸œå‘æ¥çš„ <code>sync</code> åŒ…ï¼Œåšäº†ä¸ª <code>ack</code> å›å¤ç¡®è®¤ã€ã€‚å› éš”äº†ä¸€æ®µæ—¶é—´äº†ï¼Œå°å‡ä¹Ÿä¸ç¡®å®šå°ä¸œè¿˜åœ¨ä¸åœ¨çº¿äº†ã€‚ã€è¿™æ˜¯ <code>TCP ç¬¬äºŒæ¬¡æ¡æ‰‹</code>ï¼Œå°å‡çŠ¶æ€æ­¤æ—¶å¤„äº <code>syn_rcvd</code> çŠ¶æ€ ã€‘</p>
<p>3ï¼‰å°ä¸œå› ä¸ºåˆšå¥½åœ¨çº¿ï¼Œæ”¶åˆ°äº†å°å‡çš„å›å¤ç¡®è®¤æ¶ˆæ¯ï¼Œé©¬ä¸Šå¯¹è¿™æ¬¡æ¶ˆæ¯åšäº†ä¸€ä¸ªå›å¤ã€Œå¯¹ç€å°å‡ç»™çš„ <code>sync + ack</code>ï¼Œåšäº†è¿›ä¸€æ­¥ <code>ack</code> å›å¤ç¡®è®¤ï¼Œè¿™æ˜¯ <code>TCP ç¬¬ä¸‰æ¬¡æ¡æ‰‹</code>ã€ ã€‚ã€å°å‡çŠ¶æ€æ­¤æ—¶å˜æˆäº† <code>established</code> å¯é©¬ä¸ŠèŠå¤©çŠ¶æ€ã€‘</p>
<p>4ï¼‰æ­¤æ—¶ï¼Œå°å‡ä¹Ÿåœ¨çº¿ï¼Œä¸¤ä½å°±å¼€å§‹çƒ­èŠèµ·æ¥äº†ã€‚ã€æ­£å¼ä¼ è¾“æ•°æ®äº†ï¼Œå°ä¸œå’Œå°å‡çš„çŠ¶æ€éƒ½å¤„äº <code>established</code> çŠ¶æ€ã€‘</p>
<p>ä¸Šè¿°æåˆ°çš„é‚£äº›çŠ¶æ€ <code>syn_sent</code> <code>syn_rcvd</code> <code>established</code> ï¼Œæ­£æ˜¯ TCP ä¸‰æ¬¡æ¡æ‰‹è¿‡ç¨‹ä¸­æ¶‰åŠçš„å…³é”®çŠ¶æ€ã€‚</p>
<p>ä¸Šä¸€å¼ å›¾æ¥ç›´è§‚ç†è§£ä¸‹ï¼š</p>
<p><img src="./images/ç”±ä¸€æ¬¡çº¿ä¸Šæ•…éšœæ¥ç†è§£ä¸‹ TCP ä¸‰æ¡ã€å››æŒ¥ &amp; Java å †æ ˆåˆ†æåˆ°æºç çš„æ¢ç§˜0.png" alt="file" /></p>
<h5 id="tcp-æ–­è¿å››æ¬¡æŒ¥æ‰‹è¿‡ç¨‹"><strong>3ã€ TCP æ–­è¿å››æ¬¡æŒ¥æ‰‹è¿‡ç¨‹</strong></h5>
<p>å°ä¸œå’Œå°å‡çš„çƒ­èŠç»“æŸäº†ï¼Œå·²ç»å¾ˆæ™šäº†ï¼Œä¹Ÿå¿™äº†ä¸€å¤©äº†ï¼Œéœ€è¦ä¼‘æ¯äº†ã€‚</p>
<p>å°ä¸œå› å·¥ä½œåŸå› æ˜å¤©è¦æ—©èµ·ï¼Œæ‰€ä»¥æå‰è·Ÿå°å‡è¯´äº†ï¼š</p>
<blockquote>
<p>å°ä¸œï¼šæ˜å¤©è¦å‡Œæ™¨4ç‚¹èµ·åºŠå‡çº§ç³»ç»Ÿï¼Œæˆ‘è¦æ—©ç‚¹ä¼‘æ¯äº†ï¼Œæ”¹å¤©è¿‡æ¥è¯·ä½ å–é…’ï¼<br />
å°å‡ï¼šé¢ ï¼Ÿï¼Ÿï¼Ÿè¿™æ ·ï¼Œåæ­£æˆ‘ä¹Ÿä¸æ‡‚ï¼<br />
å°å‡ï¼šé‚£ä½ æ—©ç‚¹ä¼‘æ¯å§ã€‚ä½ è¯´çš„è¿™é¡¿é…’è¿˜æ˜¯è¦å–çš„ï¼<br />
å°ä¸œï¼šå—¯å—¯ï¼Œæ™šå®‰å•Šï¼ä½ ä¹Ÿæ—©ç‚¹ä¼‘æ¯ã€‚<br />
å°å‡ï¼šå¥½çš„ï¼Œæ™šå®‰ï¼Œå…„å¼Ÿï¼</p>
</blockquote>
<p><strong>å¯¹åº”ç†è§£ TCP å››æ¬¡æŒ¥æ‰‹è¿‡ç¨‹ï¼š</strong></p>
<p>1ï¼‰å°ä¸œè¦ä¼‘æ¯äº†ï¼Œå‘èµ·äº† <code>fin1</code> åŒ…æ‰“ç®—ç»“æŸèŠå¤©äº†ã€‚ã€å°ä¸œçŠ¶æ€æ­¤æ—¶å¤„äº <code>fin_wait1</code> çŠ¶æ€ï¼Œè¿™æ˜¯ <code>TCP ç¬¬ä¸€æ¬¡æŒ¥æ‰‹</code>ã€‘</p>
<p>2ï¼‰å°å‡æ”¶åˆ°äº†å°ä¸œçš„ <code>fin1</code> åŒ…ï¼Œå›å¤äº† <code>ack</code> ç¡®è®¤æ¶ˆæ¯ã€‚ã€æ­¤æ—¶ï¼Œå°å‡çŠ¶æ€å¤„äº <code>close_wait</code> çŠ¶æ€ï¼Œå°ä¸œæ­¤æ—¶çŠ¶æ€ä¸º <code>fin_wait2</code>ï¼Œè¿™æ˜¯ <code>TCP ç¬¬äºŒæ¬¡æŒ¥æ‰‹</code>ã€‘</p>
<p>3ï¼‰å°å‡æ¥äº†ä¸€æ¬¡æœ€åç¡®è®¤ï¼Œä¸æ‰“ç®—ç»§ç»­èŠäº†ï¼Œå‘é€äº† <code>fin2</code> åŒ…ã€‚ã€æ­¤æ—¶ï¼Œå°å‡çŠ¶æ€å¤„äº <code>last_ack</code> çŠ¶æ€ï¼Œè¿™æ˜¯ <code>TCP ç¬¬ä¸‰æ¬¡æŒ¥æ‰‹</code>ã€‘</p>
<p>4ï¼‰å°ä¸œé’ˆå¯¹å°å‡å‘æ¥çš„ <code>fin2</code> åŒ…ï¼Œæœ€ç»ˆå›å¤äº†ä¸ª <code>ack</code> ç¡®è®¤ã€‚ã€æ­¤æ—¶ï¼Œå°ä¸œçŠ¶æ€å¤„äº <code>time_wait</code> çŠ¶æ€ï¼Œè¿™æ˜¯ <code>TCP ç¬¬å››æ¬¡æŒ¥æ‰‹</code>ã€‘</p>
<p>ä¸ºä»€ä¹ˆå°ä¸œè¿˜è¦å¤„äº <code>time_wait</code> çŠ¶æ€ç­‰ä¸€ä¸‹å‘¢ï¼Ÿ</p>
<p>å› ä¸ºä»–ä»¬æŒ‰ç…§ã€Œè€è§„çŸ©ã€ï¼Œå¾—ç¡®ä¿æœ€åè¿™æ¬¡æ¶ˆæ¯å°å‡çš„ç¡®æ”¶åˆ°äº†ï¼Œæ‰èƒ½æœ€ç»ˆç»“æŸè¿™æ¬¡èŠå¤©ã€‚</p>
<p><code>time_wait</code> çŠ¶æ€æ ‡å‡†æŒç»­ç­‰å¾…æ—¶é—´æ˜¯** <code>4</code>** åˆ†é’Ÿï¼Œåœ¨è¿™æ®µæ—¶é—´å†…ï¼Œå°ä¸œå’Œå°å‡å»ºç«‹çš„ TCP ç½‘ç»œè¿æ¥å¥—æ¥å­—èµ„æºï¼ˆç«¯å£ï¼‰ï¼Œæ˜¯ä¸èƒ½è¢«å…¶ä»–äººæ‰€ä½¿ç”¨çš„ï¼Œä¹Ÿä¸èƒ½è¢«ç³»ç»Ÿå›æ”¶é‡æ–°åˆ©ç”¨çš„ã€‚</p>
<p>å¦‚æœå°å‡æ²¡æœ‰æ”¶åˆ°åé¦ˆï¼Œè¿˜ä¼šç»§ç»­é—®ä¸‹ã€Œé‡å‘ fin2 æ¶ˆæ¯ã€ï¼Œç›´åˆ°å°ä¸œå‘é€äº† ack æ¶ˆæ¯æˆåŠŸäº†ã€‚<br />
åŒæ–¹æ­£å¼å…³é—­èŠå¤©é€šé“ï¼Œé‡Šæ”¾ç«¯å£èµ„æºï¼Œè¿æ¥å…³é—­ã€‚</p>
<blockquote>
<p>ç­‰å¾…çš„ 4 åˆ†é’Ÿå°±æ˜¯ 2 ä¸ª MSLï¼Œæ¯ä¸ª MSL æ˜¯ 2 åˆ†é’Ÿã€‚MSLå°±æ˜¯ maximium segment lifetimeâ€”â€”æœ€é•¿æŠ¥æ–‡å¯¿å‘½ã€‚è¿™ä¸ªæ—¶é—´æ˜¯ç”±å®˜æ–¹ RFC åè®®è§„å®šçš„ã€‚</p>
</blockquote>
<p>ä¸Šä¸€å¼ å›¾ï¼Œè¿›ä¸€æ­¥ç›´è§‚ç†è§£ä¸‹ï¼š</p>
<p><img src="./images/ç”±ä¸€æ¬¡çº¿ä¸Šæ•…éšœæ¥ç†è§£ä¸‹ TCP ä¸‰æ¡ã€å››æŒ¥ &amp; Java å †æ ˆåˆ†æåˆ°æºç çš„æ¢ç§˜1.png" alt="file" /></p>
<h5 id="ç»“åˆ-java-å †æ ˆå‰–ææºç "><strong>4ã€ç»“åˆ Java å †æ ˆå‰–ææºç </strong></h5>
<p>åˆ†æå®Œ TCP å››æ¬¡æŒ¥æ‰‹è¿‡ç¨‹äº†ï¼Œå½“æœåŠ¡ç«¯æ¥æ”¶åˆ° TCP æ–­å¼€è¿æ¥çš„è¯·æ±‚åŒ…ï¼Œéœ€è¦å›å¤ä¸€ä¸ªç¡®è®¤æ¶ˆæ¯ç»™å®¢æˆ·ç«¯ï¼Œæ­¤æ—¶æœåŠ¡ç«¯çŠ¶æ€ä¾¿å¤„äº CLOSE_WAIT çŠ¶æ€äº†ã€‚</p>
<p>æˆ‘ä»¬æ¸…æ¥šäº†è¯¥çŠ¶æ€æ‰€åœ¨çš„ç½‘ç»œè¿æ¥ä¸­çš„ä½ç½®ï¼Œç»“åˆå‰æ–‡ä¸­æåˆ°çš„é—®é¢˜ï¼Œå¤§é‡çš„çº¿ç¨‹é˜»å¡åœ¨äº† HttpClient è°ƒç”¨ä¸Šã€‚çº¿ç¨‹çŠ¶æ€ä¸º WAITINGï¼ŒæœåŠ¡å™¨ä¸Šç»Ÿè®¡å‡ºæ¥ï¼Œæœ‰å¤§é‡å¤„äº CLOSE_WAIT çŠ¶æ€çš„ç½‘ç»œè¿æ¥æ— æ³•é‡Šæ”¾ã€‚</p>
<p>çº¿ç¨‹æ˜¯ JVM è¿›ç¨‹ä¸­æ¯”è¾ƒå®è´µçš„èµ„æºï¼Œå¦‚æœä¸€ç›´æœ‰å¤§é‡çº¿ç¨‹å¤„äºç­‰å¾…æˆ–é˜»å¡çŠ¶æ€ï¼Œæ…¢æ…¢çš„æ‰€æœ‰çº¿ç¨‹éƒ½è¢«å æ»¡ï¼Œå¯¼è‡´æœåŠ¡æ²¡æ³•æ­£å¸¸å“åº”äº†ã€‚</p>
<p>æˆ‘ä»¬æ¥é€šè¿‡ java çº¿ç¨‹å †æ ˆä¿¡æ¯ï¼Œå†ç»“åˆæºç æ¥åˆ†æä¸‹å…·ä½“åŸå› ã€‚</p>
<p>æ‰¾åˆ°<code>ç¬¬ä¸€æ®µå…³é”®çš„å †æ ˆæ—¥å¿—</code>ï¼š</p>
<pre><code><code>&quot;http-nio-8970-exec-1108&quot; #24971 daemon prio=5 os_prio=0 tid=0x00007f45b4445800 nid=0x61ad waiting on condition [0x00007f444ad69000]
java.lang.Thread.State: WAITING (parking)
        at sun.misc.Unsafe.park(Native Method)
        - parking to wait for  &lt;0x00000006c2f30968&gt; (a java.util.concurrent.locks.AbstractQueuedSynchronizer$ConditionObject)
        at java.util.concurrent.locks.LockSupport.park(LockSupport.java:175)
        at java.util.concurrent.locks.AbstractQueuedSynchronizer$ConditionObject.await(AbstractQueuedSynchronizer.java:2039)
        at org.apache.http.pool.AbstractConnPool.getPoolEntryBlocking(AbstractConnPool.java:380)
        at org.apache.http.pool.AbstractConnPool.access$200(AbstractConnPool.java:69)
        at org.apache.http.pool.AbstractConnPool$2.get(AbstractConnPool.java:246)
        - locked &lt;0x0000000641c7fe38&gt; (a org.apache.http.pool.AbstractConnPool$2)
        at org.apache.http.pool.AbstractConnPool$2.get(AbstractConnPool.java:193)
        at org.apache.http.impl.conn.PoolingHttpClientConnectionManager.leaseConnection(PoolingHttpClientConnectionManager.java:303)
        at org.apache.http.impl.conn.PoolingHttpClientConnectionManager$1.get(PoolingHttpClientConnectionManager.java:279)
        at org.apache.http.impl.execchain.MainClientExec.execute(MainClientExec.java:191)
        at org.apache.http.impl.execchain.ProtocolExec.execute(ProtocolExec.java:185)
        at org.apache.http.impl.execchain.RetryExec.execute(RetryExec.java:89)
        at org.apache.http.impl.execchain.RedirectExec.execute(RedirectExec.java:111)
        at org.apache.http.impl.client.InternalHttpClient.doExecute(InternalHttpClient.java:185)
        at org.apache.http.impl.client.CloseableHttpClient.execute(CloseableHttpClient.java:83)
        at org.apache.http.impl.client.CloseableHttpClient.execute(CloseableHttpClient.java:56)
        at org.springframework.http.client.HttpComponentsClientHttpRequest.executeInternal(HttpComponentsClientHttpRequest.java:89)
        at org.springframework.http.client.AbstractBufferingClientHttpRequest.executeInternal(AbstractBufferingClientHttpRequest.java:48)
        at org.springframework.http.client.AbstractClientHttpRequest.execute(AbstractClientHttpRequest.java:53)
        at org.springframework.web.client.RestTemplate.doExecute(RestTemplate.java:660)
        at org.springframework.web.client.RestTemplate.execute(RestTemplate.java:629)
        at org.springframework.web.client.RestTemplate.getForEntity(RestTemplate.java:329)
        at com.xxx.proxy.common.util.HttpClientUtil.getForEntity(HttpClientUtil.java:267)
        at com.xxx.proxy.common.util.HttpClientUtil.getForObject(HttpClientUtil.java:521)
... ...</code></code></pre>
<p>å †æ ˆæ—¥å¿—ä¸­å‡ºç°äº†å¤§é‡çš„ä¸Šè¿°æ—¥å¿—ï¼ŒåŸºæœ¬éƒ½æ˜¯ HttpClient å·¥å…·ç±»æ‰€è°ƒç”¨çš„ï¼Œæ‰€æœ‰çº¿ç¨‹çŠ¶æ€å¤„äº <code>java.lang.Thread.State: WAITING (parking)</code> çŠ¶æ€ã€‚</p>
<p>å‡ºç° <code>WAITING (parking)</code>çº¿ç¨‹æŒ‚èµ·çŠ¶æ€ï¼Œå› ä¸ºæ¥å£æœåŠ¡å†…éƒ¨å¤§é‡è°ƒç”¨äº†ç¬¬ä¸‰æ–¹æ¥å£ï¼Œè¦è·å– Http è¿æ¥ï¼Œä½†å§‹ç»ˆæ— æ³•è·å–åˆ°ï¼Œåªèƒ½ç­‰å¾…ã€‚</p>
<p>HttpClientUtil å·¥å…·ç±»æ˜¯ç»§æ‰¿è‡ª Spring RestTemplate å¹¶åšäº†ä¸€äº›å‚æ•°ã€é‡è¯•æœºåˆ¶ã€ä»£ç†å®šåˆ¶ï¼Œå…¶åŒ…è·¯å¾„ä½äº <code>org.springframework.web.client.RestTemplate</code> ã€‚</p>
<p>ç±»å›¾å¦‚ä¸‹æ‰€ç¤ºï¼š</p>
<p><img src="./images/ç”±ä¸€æ¬¡çº¿ä¸Šæ•…éšœæ¥ç†è§£ä¸‹ TCP ä¸‰æ¡ã€å››æŒ¥ &amp; Java å †æ ˆåˆ†æåˆ°æºç çš„æ¢ç§˜2.png" alt="HttpClientUtil" /></p>
<p><strong>åˆ›å»º HttpClient å·¥å…·ç¤ºä¾‹ä»£ç ï¼š</strong></p>
<pre><code><code>HttpClientFactoryBean httpClientFactoryBean = new HttpClientFactoryBean(config);
                    HttpComponentsClientHttpRequestFactory httpRequestFactory = new HttpComponentsClientHttpRequestFactory(httpClientFactoryBean.getObject());
                    return new HttpClientUtil(httpRequestFactory);</code></code></pre>
<p>HttpClientFactoryBean ç»§æ‰¿è‡ª AbstractFactoryBeanï¼Œé‡å†™ getObjectType() å’Œ createInstance() æ–¹æ³•ã€‚</p>
<p>ç±»å›¾å¦‚ä¸‹æ‰€ç¤ºï¼š</p>
<p><img src="./images/ç”±ä¸€æ¬¡çº¿ä¸Šæ•…éšœæ¥ç†è§£ä¸‹ TCP ä¸‰æ¡ã€å››æŒ¥ &amp; Java å †æ ˆåˆ†æåˆ°æºç çš„æ¢ç§˜3.png" alt="HttpClientFactoryBean" /></p>
<p><strong>HttpClientFactoryBean éƒ¨åˆ†ç¤ºä¾‹æ–¹æ³•ï¼š</strong></p>
<pre><code><code>@Override
public Class&lt;?&gt; getObjectType() {
        return HttpClient.class;
}
        
@Override
protected HttpClient createInstance() {
    if (restConfig == null) {
            HttpClients.custom().build();
    }
    // æ¯ä¸ªè·¯ç”±æœ€å¤§çš„è¿æ¥æ•°
    int maxPerRoute = restConfig.getMaxConnections();
    // æ€»çš„æœ€å¤§è¿æ¥æ•°
    int maxTotal = restConfig.getMaxTotalConnections();
    // è¿æ¥è¶…æ—¶æ—¶é—´
    int connectTimeout = restConfig.getConnectionTimeout();
  // è¯»å–æ•°æ®çš„è¶…æ—¶æ—¶é—´
    int socketTimeout = restConfig.getTimeout();
    
    PoolingHttpClientConnectionManager connManager = new PoolingHttpClientConnectionManager(30, TimeUnit.SECONDS);
    connManager.setDefaultMaxPerRoute(maxPerRoute);
    connManager.setMaxTotal(maxTotal);
    connManager.setValidateAfterInactivity(1000);

    RequestConfig requestConfig = RequestConfig.custom().setConnectTimeout(connectTimeout)      .setSocketTimeout(socketTimeout).build();

/ ... çœç•¥éƒ¨åˆ†ä»£ç 
return HttpClients.custom().setConnectionManager(connManager).evictExpiredConnections().setDefaultRequestConfig(requestConfig).build();
}</code></code></pre>
<p>æ ¹æ®å †æ ˆä¿¡æ¯ä¹Ÿèƒ½çœ‹åˆ°æ˜¯ä» <code>PoolingHttpClientConnectionManager</code> çš„ leaseConnection() æ–¹æ³•è·å–è¿æ¥ï¼Œé‚£æˆ‘ä»¬å¯ä»¥è¯¦ç»†çœ‹ä¸‹æºä»£ç ï¼Œä¸ºä»€ä¹ˆæ²¡æœ‰è·å–æˆåŠŸå‘¢ï¼Ÿ</p>
<p>æ€ä¹ˆæŸ¥æ‰¾æºç ï¼Œé€šè¿‡å †æ ˆä¿¡æ¯ä¸­çš„è°ƒç”¨æ ˆé“¾è·¯ï¼Œå°±èƒ½éå¸¸å®¹æ˜“çš„æ‰¾åˆ°ç»è¿‡äº†å“ªäº›ç±»å“ªäº›æ–¹æ³•ï¼Œç¬¬å¤šå°‘è¡Œä»£ç ã€‚</p>
<p>æ ¹æ®ä¸Šé¢jstackä¸­çš„æ—¥å¿—ï¼š</p>
<pre><code><code>org.apache.http.pool.AbstractConnPool.getPoolEntryBlocking(AbstractConnPool.java:380)</code></code></pre>
<p>æ ¹æ®åç§°çŒœæµ‹ï¼Œé€šè¿‡ AbstractConnPool æŠ½è±¡è¿æ¥æ± çš„ç±»ï¼Œè°ƒç”¨ getPoolEntryBlocking é˜»å¡å¼æ–¹æ³•è·å–è¿æ¥ï¼Œç¬¬ 380 è¡Œä»£ç ã€‚</p>
<p>æŸ¥çœ‹æºç ï¼š</p>
<pre><code><code>private E getPoolEntryBlocking(
                    final T route, final Object state,
                    final long timeout, final TimeUnit tunit,
                    final Future&lt;E&gt; future) throws IOException, InterruptedException, TimeoutException {

    Date deadline = null;
    // è¿æ¥è·å–è¶…æ—¶æ—¶é—´å‚æ•°
    if (timeout &gt; 0) {
            deadline = new Date (System.currentTimeMillis() + tunit.toMillis(timeout));
    }
    this.lock.lock();
    try {
            final RouteSpecificPool&lt;T, C, E&gt; pool = getPool(route);
            // .... çœç•¥éƒ¨åˆ†æºç 

            boolean success = false;
            try {
                    if (future.isCancelled()) {
                            throw new InterruptedException(&quot;Operation interrupted&quot;);
                    }
                    // å°† futureï¼Œå®é™…ç±»å‹ä¸º Future&lt;CPoolEntry&gt;ï¼Œæ”¾å…¥ pending åŒå‘é“¾è¡¨é˜Ÿåˆ—ä¸­
                    pool.queue(future);
                    this.pending.add(future);
                    if (deadline != null) {
                            success = this.condition.awaitUntil(deadline);
                    } else {
                         // è¿™é‡Œæ­£æ˜¯ç¬¬ 380 è¡Œæºä»£ç 
                            this.condition.await();
                            success = true;
                    }
                    if (future.isCancelled()) {
                            throw new InterruptedException(&quot;Operation interrupted&quot;);
                    }
            } finally {
                    // In case of &#39;success&#39;, we were woken up by the
                    // connection pool and should now have a connection
                    // waiting for us, or else we&#39;re shutting down.
                    // Just continue in the loop, both cases are checked.
                    pool.unqueue(future);
                    this.pending.remove(future);
            }
            // check for spurious wakeup vs. timeout
            if (!success &amp;&amp; (deadline != null &amp;&amp; deadline.getTime() &lt;= System.currentTimeMillis()))           {
                    break;
            }
        }
        throw new TimeoutException(&quot;Timeout waiting for connection&quot;);
    } finally {
                this.lock.unlock();
    }
}</code></code></pre>
<p>æŸ¥æ‰¾åˆ°ç¬¬ 380 è¡Œæºç ï¼Œè°ƒç”¨äº† condition çš„ await() æ–¹æ³•ï¼š</p>
<pre><code><code>this.condition.await();</code></code></pre>
<p>è¿™é‡Œä½¿ç”¨äº†å¹¶å‘åŒ…ä¸‹çš„ Condition å®ç°å¤šçº¿ç¨‹åè°ƒé€šè®¯æœºåˆ¶ï¼Œawait() æ–¹æ³•è°ƒç”¨åï¼Œä¼šå°†å½“å‰çº¿ç¨‹åŠ å…¥åˆ° Condition ç­‰å¾…é˜Ÿåˆ—ä¸­ï¼Œæ˜¯ä¸€ä¸ªFIFOç»“æ„çš„é˜Ÿåˆ—ï¼ŒåŒæ—¶å½“å‰çº¿ç¨‹é”é‡Šæ”¾ï¼Œå¦‚æœä¸é‡Šæ”¾ï¼Œä¼šå¯¼è‡´å…¶ä»–çº¿ç¨‹æ— æ³•è·å¾—é”ï¼Œå¯èƒ½é€ æˆæ­»é”ã€‚</p>
<p>await() æ–¹æ³•æºç ï¼š</p>
<pre><code><code>public final void await() throws InterruptedException {
        if (Thread.interrupted())
                throw new InterruptedException();
        // åŠ å…¥ Condition ç­‰å¾…é˜Ÿåˆ—
        Node node = addConditionWaiter();
        // é‡Šæ”¾å½“å‰çº¿ç¨‹çš„é”
        long savedState = fullyRelease(node);
        int interruptMode = 0;
        // ä¸åœ¨ AQS åŒæ­¥é˜Ÿåˆ—ä¸­ï¼Œå°†å½“å‰çº¿ç¨‹æŒ‚èµ·ï¼Œå¦‚æœåœ¨ AQS é˜Ÿåˆ—ä¸­é€€å‡ºå¾ªç¯
        while (!isOnSyncQueue(node)) {
                LockSupport.park(this);
                if ((interruptMode = checkInterruptWhileWaiting(node)) != 0)
                        break;
        }
        // å·²è¢« signal() æ–¹æ³•å”¤é†’ï¼Œè‡ªæ—‹ç­‰å¾…å°è¯•å†æ¬¡è·å–é”
        if (acquireQueued(node, savedState) &amp;&amp; interruptMode != THROW_IE)
                interruptMode = REINTERRUPT;
        if (node.nextWaiter != null) // clean up if cancelled
                unlinkCancelledWaiters();
        if (interruptMode != 0)
                reportInterruptAfterWait(interruptMode);
}</code></code></pre>
<p>å½“å‰çº¿ç¨‹åŠ å…¥ Condition ç­‰å¾…é˜Ÿåˆ—ç»“æ„å›¾ï¼š</p>
<p><img src="./images/ç”±ä¸€æ¬¡çº¿ä¸Šæ•…éšœæ¥ç†è§£ä¸‹ TCP ä¸‰æ¡ã€å››æŒ¥ &amp; Java å †æ ˆåˆ†æåˆ°æºç çš„æ¢ç§˜4.png" alt="Condition ç­‰å¾…é˜Ÿåˆ—" /></p>
<p>å½“é€šè¿‡ Condtion è°ƒç”¨ signalAll() æˆ–è€… signal() æ–¹æ³•æ—¶ï¼Œä¼šè·å–ç­‰å¾…é˜Ÿåˆ—çš„é¦–èŠ‚ç‚¹ï¼Œå°†å…¶ç§»åŠ¨åˆ°åŒæ­¥é˜Ÿåˆ—ï¼Œåˆ©ç”¨ LockSupport å”¤é†’èŠ‚ç‚¹ä¸­çš„çº¿ç¨‹ã€‚èŠ‚ç‚¹ä»ç­‰å¾…é˜Ÿåˆ—ï¼Œç§»åŠ¨åˆ° AQS åŒæ­¥é˜Ÿåˆ—å¦‚ä¸‹ç»“æ„å›¾æ‰€ç¤ºï¼š</p>
<p><img src="./images/ç”±ä¸€æ¬¡çº¿ä¸Šæ•…éšœæ¥ç†è§£ä¸‹ TCP ä¸‰æ¡ã€å››æŒ¥ &amp; Java å †æ ˆåˆ†æåˆ°æºç çš„æ¢ç§˜5.png" alt="Condtion&amp;AQS åŒæ­¥é˜Ÿåˆ—" /></p>
<p>åœ¨ AbstractConnPool ç±»çš„æ‰¾åˆ°äº† release() é‡Šæ”¾è¿æ¥çš„ä»£ç ã€‚</p>
<p>release() æ–¹æ³•æºç å¦‚ä¸‹ï¼š</p>
<pre><code><code>@Override
public void release(final E entry, final boolean reusable) {
        this.lock.lock();
    try {
        if (this.leased.remove(entry)) {
                final RouteSpecificPool&lt;T, C, E&gt; pool = getPool(entry.getRoute());
                pool.free(entry, reusable);
                if (reusable &amp;&amp; !this.isShutDown) {
                        this.available.addFirst(entry);
                } else {
                        entry.close();
                }
                onRelease(entry);
                Future&lt;E&gt; future = pool.nextPending();
                if (future != null) {
                        this.pending.remove(future);
                } else {
                        future = this.pending.poll();
                }
                if (future != null) {
                        this.condition.signalAll();
                }
        }
    } finally {
            this.lock.unlock();
    }
}</code></code></pre>
<p>æˆ‘ä»¬çœ‹åˆ°äº†é‡Šæ”¾è¿æ¥æ—¶ï¼Œè°ƒç”¨ <code>this.condition.signalAll();</code> signalAll() æ–¹æ³•çš„è°ƒç”¨ä¼šå”¤é†’æ‰€æœ‰çš„æ‰€æœ‰ç­‰å¾…é˜Ÿåˆ—çº¿ç¨‹ï¼Œè™½ç„¶å”¤é†’æ‰€æœ‰ï¼Œä½†æ˜¯ä»ç„¶åªæœ‰ä¸€ä¸ªçº¿ç¨‹èƒ½æ‹¿åˆ°é”ï¼Œå…¶ä»–çº¿ç¨‹è¿˜æ˜¯éœ€è¦è‡ªæ—‹ç­‰å¾…ã€‚</p>
<p>signalAll() æ–¹æ³•æºç å¦‚ä¸‹ï¼š</p>
<pre><code><code>private void doSignalAll(Node first) {
    lastWaiter = firstWaiter = null;
    do {
            Node next = first.nextWaiter;
            first.nextWaiter = null;
            // ä¿¡å·é€šçŸ¥
            transferForSignal(first);
            first = next;
    } while (first != null);
}

final boolean transferForSignal(Node node) {
    /*
     * è®¾ç½®nodeçš„waitStatusï¼šCondition-&gt;0
     */
    if (!compareAndSetWaitStatus(node, Node.CONDITION, 0))
        return false;

         // åŠ å…¥åˆ°AQSçš„ç­‰å¾…é˜Ÿåˆ—ï¼Œè®©èŠ‚ç‚¹ç»§ç»­è·å–é”ï¼Œè®¾ç½®å‰ç½®èŠ‚ç‚¹çŠ¶æ€ä¸ºSIGNAL
    Node p = enq(node);
    int c = p.waitStatus;
    if (c &gt; 0 || !compareAndSetWaitStatus(p, c, Node.SIGNAL))
            // è°ƒç”¨ LockSupport çš„ unpark() æ–¹æ³•å”¤é†’çº¿ç¨‹
        LockSupport.unpark(node.thread);
    return true;
}</code></code></pre>
<p>å‰–æå®Œäº†åº•å±‚ä»£ç ï¼Œå›è¿‡å¤´å»ï¼Œæˆ‘ä»¬çœ‹ä¸‹æ˜¯å› ä¸ºè°ƒç”¨åˆ°äº† condition çš„ await() æ— å‚æ–¹æ³•ï¼Œå¹¶ä¸”ä¸€ç›´æ— æ³•è·å¾— Http è¿æ¥ï¼Œç„¶åä¸€ç›´å ç€ tomcat çº¿ç¨‹çš„å‘ã€‚</p>
<p>getPoolEntryBlocking() æ–¹æ³•çš„æœ€å¼€å§‹ï¼Œæœ‰ä¸ªä¸èƒ½å¿½è§†çš„ä¸€æ®µä»£ç ï¼š</p>
<pre><code><code>Date deadline = null;
// è¿æ¥è·å–è¶…æ—¶æ—¶é—´å‚æ•°
if (timeout &gt; 0) {
    deadline = new Date (System.currentTimeMillis() + tunit.toMillis(timeout));
}</code></code></pre>
<p>è¿™æ®µä»£ç ä¸€çœ‹å°±æ˜¯è¶…æ—¶æ—¶é—´ï¼ŒçŒœæµ‹ä¸€ä¸‹ï¼Œä»£ç åœ¨æ­¤å¤„ï¼Œtimeout åº”è¯¥å°±æ˜¯ä»è¿æ¥æ± è·å–è¿æ¥æ—¶çš„ç­‰å¾…æ—¶é—´ã€‚</p>
<p>getPoolEntryBocking() æ–¹æ³•çš„ä¸‹é¢çœ‹åˆ°ï¼š</p>
<pre><code><code>if (deadline != null) {
        success = this.condition.awaitUntil(deadline);
}</code></code></pre>
<p>å¦‚æœ deadline ä¸ä¸ºç©ºï¼Œä¼šè°ƒç”¨ condtion çš„ awaitUtil(deadline) æ–¹æ³•ï¼ŒawaitUtil(deadline) å‘æ–¹æ³•è¡¨ç¤ºç›´åˆ°è¾¾åˆ° deadline æ—¶é—´è¿˜æœªå”¤é†’ï¼Œå°±ä¼šè‡ªåŠ¨å”¤é†’ï¼ŒåŠ å…¥ AQS åŒæ­¥é˜Ÿåˆ—è·å–é”ã€‚</p>
<p>æˆ‘ä»¬å¯ä»¥æ ¹æ®å †æ ˆä¿¡æ¯ç»§ç»­å¾€å‰æŸ¥æ‰¾è°ƒç”¨è€…ï¼Œçœ‹çœ‹ deadline ä¸­çš„ timeout æ¥æºã€‚</p>
<pre><code><code>at org.apache.http.impl.execchain.MainClientExec.execute(MainClientExec.java:191)</code></code></pre>
<p>MainClientExec#execute() æ–¹æ³•éƒ¨åˆ†æºç ï¼š</p>
<pre><code><code>final HttpClientConnection managedConn;
    try {
        final int timeout = config.getConnectionRequestTimeout();
        managedConn = connRequest.get(timeout &gt; 0 ? timeout : 0, TimeUnit.MILLISECONDS);
    } catch(final InterruptedException interrupted) {
}</code></code></pre>
<p>è¿™é‡Œçš„ timeoutï¼Œå³ connectionRequestTimeoutï¼Œæ­£æ˜¯è®¡ç®— deadline æ—¶é—´çš„ timeout å€¼ã€‚<br />
å°è¯äº†æˆ‘ä»¬çš„çŒœæµ‹ã€‚</p>
<p>åˆå§‹åŒ– HttpClient å·¥å…·çš„åˆå§‹é…ç½®å‚æ•°ï¼Œå¹¶æ²¡æœ‰é…ç½® <code>connectionRequestTimeout</code> è¿™ä¸ªå‚æ•°çš„ï¼Œè¯¥å‚æ•°ä¹Ÿæ˜¯å¾ˆå…³é”®çš„ï¼Œå¦‚æœæ²¡æœ‰è®¾ç½®ï¼Œå¹¶ä¸”è¢« park æŒ‚èµ·çš„çº¿ç¨‹ä¸€ç›´æ²¡æœ‰è¢« signal å”¤é†’ï¼Œé‚£ä¹ˆä¼šä¸€ç›´ç­‰å¾…ä¸‹å»ã€‚</p>
<p>æ‰€ä»¥ï¼Œå¿…é¡»å¾—è®¾ç½®è¿™ä¸ªå‚æ•°ã€‚è¿™é‡Œçš„ deadline æ˜¯ä¸ªç»å¯¹æ—¶é—´ï¼Œä¸ä¸ºç©ºæ—¶ï¼Œä¼šè°ƒç”¨ condition çš„ awaitUtil(deadline) æ–¹æ³•ï¼Œå³ä½¿æ²¡æœ‰è¢« signal å”¤é†’ï¼Œä¹Ÿä¼šè‡ªåŠ¨å”¤é†’ï¼Œå»äº‰æŠ¢é”ï¼Œè€Œä¸ä¼šå¯¼è‡´æœªè¢«å”¤é†’å°±ä¸€ç›´é˜»å¡ä¸‹å»ã€‚</p>
<p>è€Œä¸”è¿™ä¸ª awaitUtil(deadline) æ–¹æ³•è·Ÿ awaitNanos(long nanosTimeout) æ–¹æ³•é‡Œçš„ deadline å˜é‡è®¾è®¡ä¸Šå¼‚æ›²åŒå·¥ã€‚</p>
<p>è¾¾åˆ°äº†è®¾å®šçš„è¶…æ—¶æ—¶é—´ï¼Œå¹¶ä¸”æ²¡æœ‰ signal è¿‡ï¼Œæœ€ç»ˆ <code>success</code> å˜é‡ä¸º false ä¸æˆåŠŸï¼Œç›´æ¥ break è·³å‡ºå¾ªç¯ï¼Œæœ€ç»ˆä¼šæŠ›å‡º TimeoutException(&quot;Timeout waiting for connection&quot;) å¼‚å¸¸ã€‚</p>
<p>æŠ›å‡ºè¿™ä¸ªå¼‚å¸¸ï¼Œç³»ç»Ÿé”™è¯¯æ—¥å¿—ä¸­ï¼Œä¹Ÿå°±æ˜ç¡®äº†æ˜¯å› ä¸ºæ— æ³•è·å¾—è¿æ¥å¯¼è‡´çš„ã€‚åŒæ—¶ï¼Œä¹Ÿé¿å…äº†ä¸€ç›´å ç”¨ç€çº¿ç¨‹ã€‚</p>
<h5 id="å†ä»å †æ ˆä¸­æ‰¾åˆ°ç½ªé­ç¥¸é¦–"><strong>5ã€å†ä»å †æ ˆä¸­æ‰¾åˆ°&quot;ç½ªé­ç¥¸é¦–&quot;</strong></h5>
<p>ä¸Šä¸€èŠ‚ï¼Œä»ç¬¬ä¸€æ®µå †æ ˆæ—¥å¿—åˆ†æåˆ°äº† Condition å¹¶å‘åº•å±‚æºç ç»†èŠ‚ã€‚<br />
ä½†æ˜¯è¿™è¿˜æ²¡å®Œï¼Œå› ä¸ºæˆ‘ä»¬ç»Ÿè®¡ <code>java.lang.Thread.State</code> ä¸­ï¼Œä»…åˆ†æå®Œäº†<code>WAITING (parking)</code> çŠ¶æ€ï¼Œé—®é¢˜åŸå› ä¹Ÿä¸ä¸€å®šæ˜¯è¿™ä¸ªçŠ¶æ€å¯¼è‡´çš„ã€‚æ¥ä¸‹æ¥ç»§ç»­åˆ†æå¦å¤–çš„ã€Œå¼‚å¸¸ã€çº¿ç¨‹çŠ¶æ€ <code>WAITING (on object monitor)</code> ã€‚</p>
<p>åœ¨ java å †æ ˆä¸­ <code>ç¬¬äºŒæ®µå…³é”®çš„æ—¥å¿—</code> å¦‚ä¸‹ï¼š</p>
<pre><code><code>&quot;http-nio-8970-exec-462&quot; #24297 daemon prio=5 os_prio=0 tid=0x00007f45b41bd000 nid=0x5f0b in Object.wait() [0x00007f446befa000]
 java.lang.Thread.State: WAITING (on object monitor)
            at java.lang.Object.wait(Native Method)
            at java.lang.Object.wait(Object.java:502)
            at java.net.InetAddress.checkLookupTable(InetAddress.java:1393)
            - locked &lt;0x00000006c05a5570&gt; (a java.util.HashMap)
            at java.net.InetAddress.getAddressesFromNameService(InetAddress.java:1310)
            at java.net.InetAddress.getAllByName0(InetAddress.java:1276)
            at java.net.InetAddress.getAllByName(InetAddress.java:1192)
            at java.net.InetAddress.getAllByName(InetAddress.java:1126)
            at org.apache.http.impl.conn.SystemDefaultDnsResolver.resolve(SystemDefaultDnsResolver.java:45)
            at org.apache.http.impl.conn.DefaultHttpClientConnectionOperator.connect(DefaultHttpClientConnectionOperator.java:112)
            at org.apache.http.impl.conn.PoolingHttpClientConnectionManager.connect(PoolingHttpClientConnectionManager.java:373)
            at org.apache.http.impl.execchain.MainClientExec.establishRoute(MainClientExec.java:381)
            at org.apache.http.impl.execchain.MainClientExec.execute(MainClientExec.java:237)
            at org.apache.http.impl.execchain.ProtocolExec.execute(ProtocolExec.java:185)
            at org.apache.http.impl.execchain.RetryExec.execute(RetryExec.java:89)
            at org.apache.http.impl.execchain.RedirectExec.execute(RedirectExec.java:111)
            at org.apache.http.impl.client.InternalHttpClient.doExecute(InternalHttpClient.java:185)
            at org.apache.http.impl.client.CloseableHttpClient.execute(CloseableHttpClient.java:83)
            at org.apache.http.impl.client.CloseableHttpClient.execute(CloseableHttpClient.java:56)
            at org.springframework.http.client.HttpComponentsClientHttpRequest.executeInternal(HttpComponentsClientHttpRequest.java:89)
            at org.springframework.http.client.AbstractBufferingClientHttpRequest.executeInternal(AbstractBufferingClientHttpRequest.java:48)
            at org.springframework.http.client.AbstractClientHttpRequest.execute(AbstractClientHttpRequest.java:53)
            at org.springframework.web.client.RestTemplate.doExecute(RestTemplate.java:660)
            at org.springframework.web.client.RestTemplate.execute(RestTemplate.java:629)
            at org.springframework.web.client.RestTemplate.getForEntity(RestTemplate.java:329)
            at com.xxx.tvproxy.common.util.HttpClientUtil.getForEntity(HttpClientUtil.java:267)
            at com.xxx.tvproxy.common.util.HttpClientUtil.getForObject(HttpClientUtil.java:521)
``

java.lang.Thread.State: WAITING (on object monitor)ï¼Œè¿™æ ·çš„çº¿ç¨‹çŠ¶æ€ä¹Ÿè¦å¼•èµ·æ ¼å¤–çš„æ³¨æ„ï¼Œç›‘è§†å¯¹è±¡é”ï¼Œå¹¶ä¸”ä¸€ç›´é˜»å¡ç€çº¿ç¨‹ä¸é‡Šæ”¾ã€‚

æ ¹æ®çº¿ç¨‹å †æ ˆä¿¡æ¯çœ‹ï¼ŒçŒœæµ‹å°±æ˜¯è·Ÿ HttpClient å‚æ•°è®¾ç½®æœ‰å…³ï¼Œæˆ‘ä»¬æ¥åˆ†æä¸‹åˆ›å»ºå‚æ•°ã€‚
æŸ¥æ‰¾æ ˆé¡¶ä¿¡æ¯çœ‹åˆ°äº†æœ‰è°ƒç”¨ Object å¯¹è±¡çš„ wait() æ–¹æ³•ï¼Œè¯´æ˜æ˜¯åœ¨ç­‰å¾…å¦å¤–çš„çº¿ç¨‹ notify é€šçŸ¥ï¼Œä½†è¿Ÿè¿Ÿæœªç­‰åˆ°ï¼Œå½“å‰çº¿ç¨‹å°±ä¸€ç›´å¤„äº WAITING çŠ¶æ€ã€‚

ç»§ç»­æŸ¥æ‰¾æ˜¯è°è°ƒç”¨çš„ï¼š
</code></code></pre>
<p>at java.net.InetAddress.checkLookupTable(InetAddress.java:1393)<br />
``</p>
<p>è¿™æ®µä»£ç è°ƒç”¨å¼•èµ·ï¼Œè¿˜æ˜¯è¦å»çœ‹ä¸‹æºç ï¼š</p>
<pre><code><code>private static InetAddress[] checkLookupTable(String host) {
    synchronized (lookupTable) {
        // If the host isn&#39;t in the lookupTable, add it in the
        // lookuptable and return null. The caller should do
        // the lookup.
        if (lookupTable.containsKey(host) == false) {
                lookupTable.put(host, null);
                return null;
        }

        // If the host is in the lookupTable, it means that another
        // thread is trying to look up the addresses of this host.
        // This thread should wait.
        while (lookupTable.containsKey(host)) {
                try {
                        // å¯¹åº”å †æ ˆä¸­çš„ java.net.InetAddress.checkLookupTable(InetAddress.java:1393)
                        lookupTable.wait();
                } catch (InterruptedException e) {
                }
        }
    }

    // The other thread has finished looking up the addresses of
    // the host. This thread should retry to get the addresses
    // from the addressCache. If it doesn&#39;t get the addresses from
    // the cache, it will try to look up the addresses itself.
    InetAddress[] addresses = getCachedAddresses(host);
    if (addresses == null) {
        synchronized (lookupTable) {
                lookupTable.put(host, null);
                return null;
        }
    }

    return addresses;
}</code></code></pre>
<p>æ‰¾åˆ°äº†æ˜¯ lookupTable å¯¹è±¡ï¼Œä½¿ç”¨äº†åŒæ­¥å—é” synchronizedï¼Œå†…éƒ¨è°ƒç”¨äº† lookupTable å¯¹è±¡çš„ wait() æ–¹æ³•ï¼Œå°±æ˜¯åœ¨è¿™é‡Œç­‰ä¸åˆ°é€šçŸ¥ï¼Œä¸€ç›´é˜»å¡ç€ã€‚</p>
<p>è¿™ä¸ªé—®é¢˜ä»£ç æ’æŸ¥ä¸€é€šï¼Œä½ æ˜¯çœ‹ä¸å‡ºä»€ä¹ˆé—®é¢˜æ¥çš„ï¼Œå› ä¸ºè·Ÿåº”ç”¨ç¨‹åºæœ¬èº«å…³ç³»ä¸å¤§äº†ï¼Œæ˜¯å› ä¸º IPV6 å¯¼è‡´çš„ JVM çº¿ç¨‹æ­»é”é—®é¢˜ã€‚</p>
<p>å‚è€ƒå›½å¤– zimbra ç«™ç‚¹ wikiï¼šhttps://wiki.zimbra.com/wiki/Configuring_for_IPv4</p>
<p>è¿™é‡Œè§£é‡Šä¸‹é—®é¢˜äº§ç”Ÿçš„åŸå› ï¼š</p>
<p>åº”ç”¨æœ¬èº«åœ¨ IPv4 ç¯å¢ƒä¸‹ï¼Œå¦‚æœå°è¯•ä½¿ç”¨äº† IPv6 ä¼šå¯¼è‡´ä¸€äº›å·²çŸ¥é—®é¢˜ã€‚</p>
<p>å½“è°ƒç”¨äº† Inet6AddressImpl.lookupAllHostAddr() æ–¹æ³•ï¼Œå› ä¸º Java ä¸æ“ä½œç³»ç»Ÿ libc åº“ä¹‹é—´å­˜åœ¨ä¸€ä¸ªbugï¼Œå½“ç‰¹å®šçš„ç«æ€æ¡ä»¶å‘ç”Ÿæ—¶ï¼Œå°†ä¼šå¯¼è‡´æŸ¥æ‰¾ host åœ°å€åŠ¨ä½œä¸€ç›´æ— é™å¾ªç¯ä¸‹å»ã€‚è¿™ç§æƒ…å†µå‘ç”Ÿçš„é¢‘ç‡å¾ˆä½ï¼Œä½†æ˜¯ä¸€æ—¦å‘ç”Ÿå°†ä¼šå¯¼è‡´ JVM æ­»é”é—®é¢˜ï¼Œè¿›è€Œå¯¼è‡´ JVM ä¸­æ‰€æœ‰çº¿ç¨‹ä¼šè¢«é˜»å¡ä½ã€‚</p>
<p>æ ¹æ®ä¸Šè¿°åˆ†æï¼Œåœ¨ jstack å †æ ˆä¸­æ‰¾åˆ°äº† <code>ç¬¬ä¸‰æ®µå…³é”®çš„å †æ ˆæ—¥å¿—</code> å¦‚ä¸‹ï¼š</p>
<pre><code><code>java.lang.Thread.State: RUNNABLE
   at java.net.Inet6AddressImpl.lookupAllHostAddr(Native Method)
   at java.net.InetAddress$2.lookupAllHostAddr(InetAddress.java:928)
   at java.net.InetAddress.getAddressesFromNameService(InetAddress.java:1323)
   at java.net.InetAddress.getAllByName0(InetAddress.java:1276)
   at java.net.InetAddress.getAllByName(InetAddress.java:1192)
   at java.net.InetAddress.getAllByName(InetAddress.java:1126)
   at org.apache.http.impl.conn.SystemDefaultDnsResolver.resolve(SystemDefaultDnsResolver.java:45)
   at org.apache.http.impl.conn.DefaultHttpClientConnectionOperator.connect(DefaultHttpClientConnectionOperator.java:112)
   at org.apache.http.impl.conn.PoolingHttpClientConnectionManager.connect(PoolingHttpClientConnectionManager.java:373)
   at org.apache.http.impl.execchain.MainClientExec.establishRoute(MainClientExec.java:381)
   at org.apache.http.impl.execchain.MainClientExec.execute(MainClientExec.java:237)
   at org.apache.http.impl.execchain.ProtocolExec.execute(ProtocolExec.java:185)
   at org.apache.http.impl.execchain.RetryExec.execute(RetryExec.java:89)
   at org.apache.http.impl.execchain.RedirectExec.execute(RedirectExec.java:111)
   at org.apache.http.impl.client.InternalHttpClient.doExecute(InternalHttpClient.java:185)
   at org.apache.http.impl.client.CloseableHttpClient.execute(CloseableHttpClient.java:83)
   at org.apache.http.impl.client.CloseableHttpClient.execute(CloseableHttpClient.java:56)
   at
   ... ...</code></code></pre>
<p><strong>å¦‚ä½•åˆ¤æ–­æ“ä½œç³»ç»Ÿæ˜¯å¦å¯ç”¨äº† IPv6 ï¼Ÿ</strong></p>
<p>ä»‹ç»ä¸¤ç§æ–¹å¼ï¼š</p>
<p>1ï¼‰ifconfig</p>
<p><img src="./images/ç”±ä¸€æ¬¡çº¿ä¸Šæ•…éšœæ¥ç†è§£ä¸‹ TCP ä¸‰æ¡ã€å››æŒ¥ &amp; Java å †æ ˆåˆ†æåˆ°æºç çš„æ¢ç§˜6.png" alt="file" /></p>
<p>è¿™ä¸ªå¾ˆæ˜æ˜¾å°±èƒ½çœ‹å¾—å‡ºæ¥ï¼Œæœ‰ <code>inet6 addr</code> å­—æ ·è¯´æ˜å¯ç”¨äº† IPv6ã€‚</p>
<p>2ï¼‰lsmod</p>
<pre><code><code>[root@BJ]# lsmod | grep ipv6
Module                  Size  Used by
ipv6                  335951  73 bridge</code></code></pre>
<p>ä¸»è¦çœ‹ Used è¿™ä¸€åˆ—ï¼Œæ•°å€¼ 70+ï¼Œä¸æ”¯æŒ IPv6 ç¯å¢ƒ Used åˆ—æ˜¯ 1ã€‚</p>
<h5 id="é—®é¢˜ä¼˜åŒ–æ–¹æ¡ˆæ€»ç»“"><strong>6ã€é—®é¢˜ä¼˜åŒ–æ–¹æ¡ˆæ€»ç»“</strong></h5>
<p>ç»è¿‡å¯¹ java å †æ ˆä¸­å…³é”®çº¿ç¨‹çŠ¶æ€çš„åˆ†æï¼Œæ˜ç¡®äº†é—®é¢˜åŸå› ï¼Œæ¥ä¸‹æ¥è¯´ä¸‹é—®é¢˜è§£å†³æ–¹æ¡ˆã€‚</p>
<p><strong>ç¬¬ä¸€ä¸ªé—®é¢˜ï¼š</strong></p>
<p>é’ˆå¯¹ä» Http è¿æ¥æ± ä¸­è·å–ä¸åˆ°è¿æ¥æ—¶ï¼Œå¯èƒ½ä½¿çº¿ç¨‹è¿›å…¥é˜»å¡çŠ¶æ€ã€‚</p>
<p>åœ¨ HttpClient å®¢æˆ·ç«¯åˆå§‹åŒ–å‚æ•°é…ç½®ä¸­å¢åŠ  <code>connectionRequestTimeout</code> ï¼Œè·å–è¿æ¥çš„è¶…æ—¶æ—¶é—´ï¼Œä¸€èˆ¬ä¸å»ºè®®è¿‡å¤§ï¼Œæˆ‘ä»¬è®¾ç½®ä¸º 500msã€‚</p>
<p>è®¾ç½®åï¼Œå°±ä¼šè°ƒç”¨åº•å±‚çš„ condition#awaitUtil(deadline) æ–¹æ³•ï¼Œå½“çº¿ç¨‹æ— æ³•è¢« signal å”¤é†’ï¼Œåˆ°è¾¾äº† deadline ç»å¯¹æ—¶é—´åï¼Œçº¿ç¨‹ä¼šè‡ªåŠ¨ä»ç­‰å¾…é˜Ÿåˆ—ä¸­è¢«å”¤é†’ï¼ŒåŠ å…¥åˆ° AQS åŒæ­¥é˜Ÿåˆ—äº‰æŠ¢é”ã€‚</p>
<p><strong>ç¬¬äºŒä¸ªé—®é¢˜ï¼š</strong></p>
<p>é’ˆå¯¹ IPv6 å¯¼è‡´çš„ JVM è¿›ç¨‹æ­»é”é—®é¢˜ï¼Œæœ‰ä¸¤ç§è§£å†³æ–¹æ¡ˆï¼š</p>
<p>1ï¼‰æ“ä½œç³»ç»Ÿå±‚é¢ç¦ç”¨ IPv6</p>
<p>ç¼–è¾‘ /etc/sysctl.conf æ–‡ä»¶<br />
æ·»åŠ ä¸‹é¢ä¸¤è¡Œï¼š</p>
<pre><code><code>net.ipv6.conf.all.disable_ipv6 = 1
net.ipv6.conf.default.disable_ipv6 = 1</code></code></pre>
<p>ä¿å­˜ï¼Œæ‰§è¡Œ <code>sysctl -p</code> ä½¿å…¶ç”Ÿæ•ˆã€‚</p>
<p>è¿è¡Œæ“ä½œç³»ç»Ÿä¸­æ‰§è¡Œå¦‚ä¸‹å‘½ä»¤ç›´æ¥ç”Ÿæ•ˆï¼š</p>
<pre><code><code>sysctl -w net.ipv6.conf.all.disable_ipv6=1
sysctl -w net.ipv6.conf.default.disable_ipv6=1</code></code></pre>
<p>2ï¼‰Java åº”ç”¨ç¨‹åºå±‚é¢</p>
<p>åœ¨åº”ç”¨ JVM å¯åŠ¨å‚æ•°ä¸Šæ·»åŠ  <code>-Djava.net.preferIPv4Stack=true</code> ã€‚</p>
<p>ä»æ“ä½œç³»ç»Ÿå±‚é¢ç¦ç”¨ IPv6ï¼Œå¦‚æœæœåŠ¡å™¨ä¸Šè¿˜éƒ¨ç½²äº†å…¶ä»–åº”ç”¨ï¼Œæ³¨æ„è§‚å¯Ÿä¸‹ï¼Œå¦‚æœé‡åˆ°ä¸€äº›é—®é¢˜å¯ä»¥å€ŸåŠ©æœç´¢å¼•æ“æŸ¥ä¸‹ã€‚</p>
<p>æˆ‘ä»¬æœ‰å¾ˆå¤šå°æœåŠ¡å™¨ï¼Œéƒ½æ˜¯è¿ç»´æ¥ç»´æŠ¤çš„ï¼Œæ‰€ä»¥æˆ‘é‡‡ç”¨äº†ç¬¬äºŒç§æ–¹å¼ï¼Œç›´æ¥åœ¨ JVM ä¸Šå¢åŠ å‚æ•°ï¼Œç®€å•æ–¹ä¾¿ã€‚</p>
<p><strong>æœ€åçš„æ€»ç»“ï¼š</strong></p>
<p>java å †æ ˆæ—¥å¿—ä¸­ä¸¤ä¸ªå…³é”®çš„ <code>WAITING</code> çº¿ç¨‹çŠ¶æ€ï¼Œå…ˆå‡ºç°äº† <code>WAITING (on object monitor)</code>ï¼Œå›  IPv6 é—®é¢˜è§¦å‘äº† HttpClient çº¿ç¨‹æ± æ‰€æœ‰çº¿ç¨‹é˜»å¡ã€‚åå‡ºç°äº† <code>WAITING (parking)</code> ï¼ŒTomcat çº¿ç¨‹æ¥æ”¶è½¬å‘è¯·æ±‚ï¼Œå½“è¯·æ±‚è°ƒç”¨åˆ° HttpClientï¼Œå› æ— æ³•è·å¾— Http è¿æ¥èµ„æºï¼Œä¸”æœªè®¾ç½®è·å–è¿æ¥çš„è¶…æ—¶æ—¶é—´ï¼Œé€ æˆäº†å¤§é‡çº¿ç¨‹é˜»å¡ã€‚</p>
<p>ç»è¿‡å¯¹ä¸Šè¿°ä¸¤ä¸ªé—®é¢˜çš„ä¼˜åŒ–åï¼Œä¸Šçº¿è§‚å¯Ÿå¾ˆé•¿ä¸€æ®µæ—¶é—´ï¼Œä¹Ÿç»å†è¿‡æ¯”è¿™æ¬¡é—®é¢˜å‡ºç°æ—¶æ›´é«˜çš„è®¿é—®é‡ï¼Œå†æ²¡æœ‰å‡ºç°è¿‡ JVM çº¿ç¨‹é˜»å¡é—®é¢˜ã€‚<br />
é€šè¿‡ç½‘ç»œå‘½ä»¤è¡Œç»Ÿè®¡ï¼ŒåŸºæœ¬ä¸ä¼šå‡ºç°å¤§é‡çš„ <code>CLOSE_WAIT</code> ç½‘ç»œè¿æ¥çŠ¶æ€ã€‚</p>
<p>æ¬¢è¿å…³æ³¨æˆ‘çš„å…¬ä¼—å·ï¼Œæ‰«äºŒç»´ç å…³æ³¨è·å¾—æ›´å¤šç²¾å½©æ–‡ç« ï¼Œä¸ä½ ä¸€åŒæˆé•¿~<br />
<img src="./images/ç”±ä¸€æ¬¡çº¿ä¸Šæ•…éšœæ¥ç†è§£ä¸‹ TCP ä¸‰æ¡ã€å››æŒ¥ &amp; Java å †æ ˆåˆ†æåˆ°æºç çš„æ¢ç§˜7.png" alt="Javaçˆ±å¥½è€…ç¤¾åŒº" /></p>


</div><hr><script charset='utf-8' src='../../js/sming.js'></script></body></html>